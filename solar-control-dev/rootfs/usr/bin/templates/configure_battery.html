{% extends "base.html" %}

{% block title %}Configure Battery - Solar Control{% endblock %}

{% block heading %}Configure Battery Settings{% endblock %}

{% block content %}
    <div class="card">
        <form id="batteryForm" class="form">
            <div class="form-group">
                <label for="size_kwh">Battery Size (kWh)</label>
                <input type="number" id="size_kwh" name="size_kwh" step="0.1" min="0" required>
            </div>

            <div class="form-group">
                <label for="battery_percent_entity">Battery Percentage Sensor</label>
                <div class="searchable-select">
                    <input type="text" id="battery_percent_entity_input" placeholder="Search for a battery percentage sensor..." autocomplete="off">
                    <input type="hidden" name="battery_percent_entity" id="battery_percent_entity" value="{{ config.battery_percent_entity if config else '' }}">
                    <div class="options" id="battery_percent_entity_options">
                        {% for entity in entities %}
                            {% if entity.entity_id.startswith('sensor.') and 'battery' in entity.entity_id.lower() and 'percentage' in entity.entity_id.lower() %}
                                <div class="option" data-value="{{ entity.entity_id }}"
                                     {% if config and entity.entity_id == config.battery_percent_entity %}data-selected="true"{% endif %}>
                                    {{ entity.attributes.friendly_name }} ({{ entity.entity_id }})
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
                <small class="form-text text-muted">Select a sensor that reports battery percentage (0-100%)</small>
            </div>

            <div class="form-group">
                <label for="max_charging_speed_kw">Maximum Charging Speed (kW)</label>
                <input type="number" id="max_charging_speed_kw" name="max_charging_speed_kw" step="0.1" min="0">
                <small class="form-text text-muted">Optional: Maximum charging speed in kilowatts</small>
            </div>

            <div class="form-group">
                <label for="force_charge_entity">Force Charge Switch</label>
                <div class="searchable-select">
                    <input type="text" id="force_charge_entity_input" placeholder="Search for a force charge switch..." autocomplete="off">
                    <input type="hidden" name="force_charge_entity" id="force_charge_entity" value="{{ config.force_charge_entity if config else '' }}">
                    <div class="options" id="force_charge_entity_options">
                        {% for entity in entities %}
                            {% if entity.entity_id.startswith('switch.') and 'battery' in entity.entity_id.lower() and 'charge' in entity.entity_id.lower() %}
                                <div class="option" data-value="{{ entity.entity_id }}"
                                     {% if config and entity.entity_id == config.force_charge_entity %}data-selected="true"{% endif %}>
                                    {{ entity.attributes.friendly_name }} ({{ entity.entity_id }})
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
                <small class="form-text text-muted">Optional: Switch entity to force battery charging</small>
            </div>

            <div class="form-actions">
                <button type="submit" class="button">Save Configuration</button>
            </div>
        </form>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize searchable selects
            new SearchableSelect('battery_percent_entity_input', 'battery_percent_entity_options', 'battery_percent_entity');
            new SearchableSelect('force_charge_entity_input', 'force_charge_entity_options', 'force_charge_entity');

            // Load existing configuration
            fetch('/api/battery')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        const config = data.config;
                        document.getElementById('size_kwh').value = config.size_kwh || '';
                        document.getElementById('max_charging_speed_kw').value = config.max_charging_speed_kw || '';
                        
                        // Set the searchable select values
                        if (config.battery_percent_entity) {
                            const batteryPercentInput = document.getElementById('battery_percent_entity_input');
                            const batteryPercentOption = document.querySelector(`#battery_percent_entity_options .option[data-value="${config.battery_percent_entity}"]`);
                            if (batteryPercentOption) {
                                batteryPercentInput.value = batteryPercentOption.textContent;
                            }
                        }
                        
                        if (config.force_charge_entity) {
                            const forceChargeInput = document.getElementById('force_charge_entity_input');
                            const forceChargeOption = document.querySelector(`#force_charge_entity_options .option[data-value="${config.force_charge_entity}"]`);
                            if (forceChargeOption) {
                                forceChargeInput.value = forceChargeOption.textContent;
                            }
                        }
                    }
                })
                .catch(error => console.error('Error loading battery configuration:', error));

            // Handle form submission
            document.getElementById('batteryForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const formData = {
                    size_kwh: parseFloat(document.getElementById('size_kwh').value),
                    battery_percent_entity: document.getElementById('battery_percent_entity').value,
                    max_charging_speed_kw: document.getElementById('max_charging_speed_kw').value ? 
                        parseFloat(document.getElementById('max_charging_speed_kw').value) : null,
                    force_charge_entity: document.getElementById('force_charge_entity').value || null
                };

                fetch('/api/battery', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('Battery configuration saved successfully');
                    } else {
                        alert('Error saving battery configuration: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error saving battery configuration');
                });
            });
        });
    </script>
{% endblock %} 