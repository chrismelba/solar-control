{% extends "base.html" %}
{% from "components/entity_selector.html" import entity_field %}

{% block title %}Configure Battery - Solar Control{% endblock %}

{% block heading %}Configure Battery Settings{% endblock %}

{% block content %}
    <div class="card">
        <form id="batteryForm" class="form">
            <div class="form-group">
                <label for="size_kwh">Battery Size (kWh)</label>
                <input type="number" id="size_kwh" name="size_kwh" step="0.1" min="0" required>
            </div>

            {{ entity_field(
                'battery_percent_entity', entities,
                label='Battery Percentage Sensor',
                filter_type='sensor_battery',
                placeholder='Search for a battery percentage sensor...',
                help_text='Select a sensor that reports battery percentage (0-100%).',
                selected_value=(config.battery_percent_entity or '') if config else ''
            ) }}

            <div class="form-group">
                <label for="max_charging_speed_kw">Maximum Charging Speed (kW)</label>
                <input type="number" id="max_charging_speed_kw" name="max_charging_speed_kw" step="0.1" min="0">
                <small class="form-text text-muted">Optional: Maximum charging speed in kilowatts</small>
            </div>

            <div class="form-group">
                <label for="expected_kwh_per_hour">Expected kWh used per hour <span class="tooltip">ⓘ<span class="tooltiptext">This value will be subtracted from the solar forecast to determine if there's enough energy left today to fill the battery</span></span></label>
                <input type="number" id="expected_kwh_per_hour" name="expected_kwh_per_hour" step="0.1" min="0">
                <small class="form-text text-muted">Optional: Expected household energy consumption per hour</small>
            </div>

            <div class="form-group">
                <label for="bring_forward_mode">Bring Forward Mode <span class="tooltip">ⓘ<span class="tooltiptext">Experimental mode, this will attempt to shift load forward in the day if your battery is sufficently charged and there is enough sun to fill it. It will start to charge a car off the battery so that if you drive away the battery can take the excees solar</span></span></label>
                <div class="toggle-switch">
                    <input type="checkbox" id="bring_forward_mode" name="bring_forward_mode">
                    <label for="bring_forward_mode" class="toggle-label"></label>
                </div>
                <small class="form-text text-muted">Experimental: Shift load forward when battery is sufficiently charged</small>
            </div>

            <div class="form-actions">
                <button type="submit" class="button">Save Configuration</button>
            </div>
        </form>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Load existing configuration
            apiCall('/api/battery')
                .then(data => {
                    if (data.status === 'success') {
                        const config = data.config;
                        document.getElementById('size_kwh').value = config.size_kwh || '';
                        document.getElementById('max_charging_speed_kw').value = config.max_charging_speed_kw || '';
                        document.getElementById('expected_kwh_per_hour').value = config.expected_kwh_per_hour || '';
                        document.getElementById('bring_forward_mode').checked = config.bring_forward_mode || false;
                    }
                })
                .catch(error => console.error('Error loading battery configuration:', error));

            // Handle form submission
            document.getElementById('batteryForm').addEventListener('submit', function(e) {
                e.preventDefault();

                // Get form values
                const sizeKwh = document.getElementById('size_kwh').value;
                const batteryPercentEntity = document.getElementById('battery_percent_entity').value;
                const maxChargingSpeedKw = document.getElementById('max_charging_speed_kw').value;
                const expectedKwhPerHour = document.getElementById('expected_kwh_per_hour').value;
                const bringForwardMode = document.getElementById('bring_forward_mode').checked;

                // Validate required fields
                if (!sizeKwh || !batteryPercentEntity) {
                    alert('Please fill in all required fields (Battery Size and Battery Percentage Sensor)');
                    return;
                }

                const formData = {
                    size_kwh: parseFloat(sizeKwh),
                    battery_percent_entity: batteryPercentEntity,
                    max_charging_speed_kw: maxChargingSpeedKw ? parseFloat(maxChargingSpeedKw) : null,
                    expected_kwh_per_hour: expectedKwhPerHour ? parseFloat(expectedKwhPerHour) : null,
                    bring_forward_mode: bringForwardMode
                };

                apiCall('/api/battery', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                })
                .then(data => {
                    if (data.status === 'success') {
                        alert('Battery configuration saved successfully');
                    } else {
                        alert('Error saving battery configuration: ' + (data.message || 'Unknown error'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error saving battery configuration: ' + error.message);
                });
            });
        });
    </script>

{% endblock %}
