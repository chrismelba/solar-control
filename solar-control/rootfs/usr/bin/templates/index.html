{% extends "base.html" %}
{% from "components/device_card.html" import device_card %}

{% block title %}Solar Control Dashboard{% endblock %}

{% block heading %}Solar Control Dashboard{% endblock %}

{% block content %}
    <div class="nav-menu">
        <a href="{{ url_for('configure_solar') }}" class="button">Configure Solar</a>
        <a href="{{ url_for('configure_battery') }}" class="button">Configure Battery</a>
        <a href="{{ url_for('configure_devices') }}" class="button">Configure Devices</a>
    </div>
    
    <div class="card" id="sensor-values">
        <h2>Current Sensor Values</h2>
        <div class="sensor-grid">
            <div class="sensor-card">
                <h3>Solar Generation</h3>
                {% if sensor_values.solar_generation %}
                    <p class="value">{{ sensor_values.solar_generation.state }} {{ sensor_values.solar_generation.unit }}</p>
                    <p class="name">{{ sensor_values.solar_generation.friendly_name }}</p>
                {% else %}
                    <p class="value">Not configured</p>
                {% endif %}
            </div>
            
            <div class="sensor-card">
                <h3>Grid Power</h3>
                {% if sensor_values.grid_power %}
                    <p class="value">{{ sensor_values.grid_power.state }} {{ sensor_values.grid_power.unit }}</p>
                    <p class="name">{{ sensor_values.grid_power.friendly_name }}</p>
                {% else %}
                    <p class="value">Not configured</p>
                {% endif %}
            </div>
            
            <div class="sensor-card">
                <h3>Solar Forecast</h3>
                {% if sensor_values.solar_forecast %}
                    <p class="value">{{ sensor_values.solar_forecast.state }} {{ sensor_values.solar_forecast.unit }}</p>
                    <p class="name">{{ sensor_values.solar_forecast.friendly_name }}</p>
                {% else %}
                    <p class="value">Not configured</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="card" id="devices">
        <h2>Controllable Devices</h2>
        <div id="deviceList" class="device-list">
            <p>Loading devices...</p>
        </div>
    </div>

    <div class="card" id="status">
        <h2>System Status</h2>
        <p>Loading status...</p>
    </div>

    <style>
        .sensor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }
        .sensor-card {
            background: #f5f5f5;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
        }
        .sensor-card h3 {
            margin: 0 0 0.5rem 0;
            color: #333;
        }
        .sensor-card .value {
            font-size: 1.5rem;
            font-weight: bold;
            margin: 0.5rem 0;
            color: #2196F3;
        }
        .sensor-card .name {
            font-size: 0.9rem;
            color: #666;
            margin: 0;
        }
        .device-list {
            margin-top: 1rem;
        }
    </style>

    <script>
        // Fetch status from API
        fetch('/api/status')
            .then(response => response.json())
            .then(data => {
                document.querySelector('#status p').textContent = 
                    `Status: ${data.status}, Version: ${data.version}`;
            })
            .catch(error => {
                document.querySelector('#status p').textContent = 
                    'Error loading status';
            });

        // Load and display devices
        async function loadDevices() {
            try {
                const response = await fetch('/api/devices');
                const devices = await response.json();
                
                const deviceList = document.getElementById('deviceList');
                deviceList.innerHTML = '';
                
                // Sort devices by order
                devices.sort((a, b) => a.order - b.order);
                
                devices.forEach(device => {
                    const deviceElement = document.createElement('div');
                    deviceElement.innerHTML = `{{ device_card(device, draggable=true) }}`;
                    deviceList.appendChild(deviceElement.firstElementChild);
                });
                
                // Initialize drag and drop
                initializeDragAndDrop();
            } catch (error) {
                document.getElementById('deviceList').innerHTML = 
                    '<p>Error loading devices</p>';
            }
        }

        function initializeDragAndDrop() {
            const deviceList = document.getElementById('deviceList');
            const items = deviceList.querySelectorAll('.device-card.draggable');
            
            items.forEach(item => {
                item.addEventListener('dragstart', () => {
                    item.classList.add('dragging');
                });
                
                item.addEventListener('dragend', () => {
                    item.classList.remove('dragging');
                    updateDeviceOrder();
                });
            });
            
            deviceList.addEventListener('dragover', e => {
                e.preventDefault();
                const draggingItem = deviceList.querySelector('.dragging');
                const siblings = [...deviceList.querySelectorAll('.device-card:not(.dragging)')];
                
                const nextSibling = siblings.find(sibling => {
                    const box = sibling.getBoundingClientRect();
                    const offset = e.clientY - box.top - box.height / 2;
                    return offset < 0;
                });
                
                deviceList.insertBefore(draggingItem, nextSibling);
            });
        }

        async function updateDeviceOrder() {
            const items = document.querySelectorAll('.device-card');
            const orderData = Array.from(items).map((item, index) => ({
                name: item.dataset.deviceName,
                order: index
            }));
            
            try {
                const response = await fetch('/api/devices/reorder', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(orderData)
                });
                
                if (!response.ok) {
                    throw new Error('Failed to update device order');
                }
            } catch (error) {
                console.error('Error updating device order:', error);
            }
        }

        // Load devices when page loads
        document.addEventListener('DOMContentLoaded', loadDevices);
    </script>
{% endblock %} 