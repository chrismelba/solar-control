{% extends "base.html" %}
{% from "components/entity_selector.html" import entity_field, entity_widget %}

{% block title %}Configure Grid - Solar Control{% endblock %}

{% block heading %}Configure Grid Settings{% endblock %}

{% block content %}
    <div class="card">
        <h2>Current Sensor Values</h2>
        <div class="sensor-grid">
            <div class="sensor-card">
                <h3>Solar Generation</h3>
                {% if sensor_values.solar_generation %}
                    <p class="value" data-original-value="{{ sensor_values.solar_generation.state }}" data-original-unit="{{ sensor_values.solar_generation.unit }}"></p>
                    <p class="name">{{ sensor_values.solar_generation.friendly_name }}</p>
                {% else %}
                    <p class="value">Not configured</p>
                {% endif %}
            </div>

            <div class="sensor-card">
                <h3>Grid Power</h3>
                {% if sensor_values.grid_power %}
                    <p class="value" data-original-value="{{ sensor_values.grid_power.state }}" data-original-unit="{{ sensor_values.grid_power.unit }}"></p>
                    <p class="name">{{ sensor_values.grid_power.friendly_name }}</p>
                {% else %}
                    <p class="value">Not configured</p>
                {% endif %}
            </div>

            <div class="sensor-card">
                <h3>Solar Forecast</h3>
                {% if sensor_values.solar_forecast %}
                    <p class="value" data-original-value="{{ sensor_values.solar_forecast.state }}" data-original-unit="{{ sensor_values.solar_forecast.unit }}"></p>
                    <p class="name">{{ sensor_values.solar_forecast.friendly_name }}</p>
                {% else %}
                    <p class="value">Not configured</p>
                {% endif %}
            </div>
        </div>
    </div>

    <form method="POST">
        <div class="card">
            <h2>Configure Sensors</h2>

            {{ entity_field(
                'solar_generation', entities,
                label='Solar Generation Entity:',
                filter_type='sensor_power',
                placeholder='Search for a solar generation sensor...',
                tooltip='Select the sensor that measures your solar panel\'s power generation. This should be a power sensor that shows how much power your solar panels are currently producing.',
                selected_value=(config.solar_generation or '') if config else ''
            ) }}

            {{ entity_field(
                'grid_power', entities,
                label='Grid Power Entity:',
                filter_type='sensor_power',
                placeholder='Search for a grid power sensor...',
                tooltip='Select the sensor that measures power flow to/from the grid. Negative values indicate power being exported to the grid, positive values indicate power being imported from the grid.',
                selected_value=(config.grid_power or '') if config else ''
            ) }}

            {{ entity_field(
                'solar_forecast', entities,
                label='Solar Forecast Entity:',
                filter_type='sensor_forecast',
                placeholder='Search for a solar forecast sensor...',
                tooltip='Select a sensor that provides solar generation forecast remaining today. Currently this does nothing, but will be used in the future to optimize battery usage.',
                selected_value=(config.solar_forecast or '') if config else ''
            ) }}

            <div class="form-group">
                <label for="grid_voltage_input">Grid Voltage: <span class="tooltip">ⓘ<span class="tooltiptext">Select a sensor that measures grid voltage, or enter a fixed value. This is used to calculate power for variable amperage devices.</span></span></label>
                <div class="input-group">
                    {{ entity_widget(
                        'grid_voltage', entities,
                        filter_type='sensor',
                        placeholder='Search for an entity...',
                        selected_value=(config.grid_voltage or '') if config else ''
                    ) }}
                    <span class="or-divider">or</span>
                    <input type="number" name="grid_voltage_fixed" id="grid_voltage_fixed"
                           placeholder="Enter fixed voltage value" step="0.1" min="0"
                           value="{{ config.grid_voltage_fixed if config and config.grid_voltage_fixed else '' }}">
                    <span class="unit">V</span>
                </div>
            </div>

            <div class="form-group">
                <label for="site_export_limit">Site Export Limit: <span class="tooltip">ⓘ<span class="tooltiptext">Set the maximum amount of power that can be exported to the grid. This is currently unused, but will be used in future to best utilize export limited power</span></span></label>
                <div class="input-group">
                    <input type="number" name="site_export_limit" id="site_export_limit"
                           placeholder="Enter maximum export limit" step="0.1" min="0"
                           value="{{ config.site_export_limit if config and config.site_export_limit else '' }}">
                    <span class="unit">W</span>
                </div>
                <p class="help-text">Maximum power that can be exported to the grid. Leave empty for no limit.</p>
            </div>

            <div class="form-group">
                <label for="tariff_rate_input">Tariff Rate Entity: <span class="tooltip">ⓘ<span class="tooltiptext">Select a sensor that provides your current electricity tariff rate. This is not currently used, but will be used in future to manage off-peak power when solar is insufficient.</span></span></label>
                {{ entity_widget(
                    'tariff_rate', entities,
                    filter_type='select',
                    placeholder='Search for a tariff rate entity...',
                    selected_value=(config.tariff_rate or '') if config else ''
                ) }}
                <div id="tariff_mode_container" class="tariff-mode-container" style="display: none; margin-top: 1rem;">
                    <h4>Configure Tariff Modes <span class="tooltip">ⓘ<span class="tooltiptext">During normal power no controllable devices will be turned on. During cheap energy times you can select your devices to continue until they've run for a certain time or delivered a certain number of kWh and during free power periods all devices will run at maximum</span></span></h4>
                    <div class="tariff-modes-grid">
                        <div class="tariff-mode-header">
                            <div class="tariff-name">Tariff Rate</div>
                            <div class="tariff-mode-options">
                                <div class="mode-label">Mode</div>
                            </div>
                        </div>
                        <div id="tariff_modes_list" class="tariff-modes-list">
                            <!-- Options will be populated by JavaScript -->
                        </div>
                    </div>
                    <input type="hidden" name="tariff_modes" id="tariff_modes" value="{{ config.tariff_modes|default('{}') }}">
                </div>
            </div>

            <button type="submit" class="button">Save Configuration</button>
        </div>
    </form>

    <script>
        function convertToWatts(value, unit) {
            if (!value || !unit) return null;

            // Convert to watts
            if (unit.toLowerCase() === 'kw') {
                return (parseFloat(value) * 1000).toFixed(0);
            } else if (unit.toLowerCase() === 'w') {
                return parseFloat(value).toFixed(0);
            }
            return value;
        }

        function updateDisplayedValues() {
            document.querySelectorAll('.sensor-card .value[data-original-value]').forEach(element => {
                const originalValue = element.getAttribute('data-original-value');
                const originalUnit = element.getAttribute('data-original-unit');
                const convertedValue = convertToWatts(originalValue, originalUnit);

                if (convertedValue !== null) {
                    element.textContent = `${convertedValue} W`;
                }
            });
        }

        // Update values when the page loads
        document.addEventListener('DOMContentLoaded', updateDisplayedValues);

        // Set up tariff rate select callback (all other selects auto-initialized)
        document.addEventListener('DOMContentLoaded', function() {
            const tariffRateSelect = SearchableSelect.getOrCreate('tariff_rate_input', 'tariff_rate_options', 'tariff_rate');
            tariffRateSelect.onSelectCallback = onTariffRateSelect;

            // Trigger callback for initial value if exists
            const initialValue = document.getElementById('tariff_rate').value;
            if (initialValue) {
                const selectedOption = document.querySelector(`#tariff_rate_options .option[data-value="${initialValue}"]`);
                if (selectedOption) {
                    // Show the container immediately
                    const container = document.getElementById('tariff_mode_container');
                    container.style.display = 'block';
                    // Then trigger the callback
                    onTariffRateSelect(initialValue, selectedOption.textContent);
                }
            }
        });

        function onTariffRateSelect(selectedValue, selectedText) {
            const container = document.getElementById('tariff_mode_container');
            const list = document.getElementById('tariff_modes_list');

            if (selectedValue) {
                // Show the container immediately
                container.style.display = 'block';

                // Fetch tariff modes from our API
                apiCall('/api/tariff_modes')
                    .then(data => {
                        // Get the available modes, current assignments, and options
                        const availableModes = data.modes || ['normal', 'cheap', 'free'];
                        const currentModes = data.current_modes || {};
                        const options = data.options || [];

                        // Clear existing options
                        list.innerHTML = '';

                        // Filter out any old mode assignments that aren't in the new options
                        const filteredModes = {};
                        options.forEach(option => {
                            if (currentModes[option]) {
                                filteredModes[option] = currentModes[option];
                            }
                        });

                        // Update the hidden input with filtered modes
                        document.getElementById('tariff_modes').value = JSON.stringify(filteredModes);

                        // Create items for each tariff rate option
                        options.forEach(option => {
                            const item = document.createElement('div');
                            item.className = 'tariff-mode-item';
                            item.dataset.value = option;

                            // Create tariff name
                            const nameDiv = document.createElement('div');
                            nameDiv.className = 'tariff-name';
                            nameDiv.textContent = option;
                            item.appendChild(nameDiv);

                            // Create mode options
                            const optionsDiv = document.createElement('div');
                            optionsDiv.className = 'tariff-mode-options';

                            availableModes.forEach(mode => {
                                const optionDiv = document.createElement('div');
                                optionDiv.className = 'mode-option';
                                optionDiv.dataset.mode = mode;
                                optionDiv.textContent = mode.charAt(0).toUpperCase() + mode.slice(1);

                                // Add click handler
                                optionDiv.addEventListener('click', () => {
                                    // Remove selected class from all options in this item
                                    item.querySelectorAll('.mode-option').forEach(opt => {
                                        opt.classList.remove('selected');
                                    });
                                    // Add selected class to clicked option
                                    optionDiv.classList.add('selected');
                                    updateTariffModes();
                                });

                                optionsDiv.appendChild(optionDiv);
                            });

                            item.appendChild(optionsDiv);
                            list.appendChild(item);
                        });

                        // Restore saved modes if exists
                        Object.entries(filteredModes).forEach(([tariff, mode]) => {
                            const item = list.querySelector(`[data-value="${tariff}"]`);
                            if (item) {
                                const option = item.querySelector(`[data-mode="${mode}"]`);
                                if (option) {
                                    option.classList.add('selected');
                                }
                            }
                        });
                    })
                    .catch(error => {
                        console.error('Error fetching tariff modes:', error);
                        // Don't hide the container on error, just show an error message
                        list.innerHTML = '<div class="error-message">Error loading tariff modes. Please try again.</div>';
                    });
            } else {
                container.style.display = 'none';
                // Clear the tariff modes when no entity is selected
                document.getElementById('tariff_modes').value = '{}';
            }
        }

        function updateTariffModes() {
            const modes = {};
            document.querySelectorAll('.tariff-mode-item').forEach(item => {
                const value = item.dataset.value;
                const selectedMode = item.querySelector('.mode-option.selected');
                if (value && selectedMode) {
                    modes[value] = selectedMode.dataset.mode;
                }
            });
            document.getElementById('tariff_modes').value = JSON.stringify(modes);
        }
    </script>

{% endblock %}
